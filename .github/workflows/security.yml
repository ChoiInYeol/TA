name: 보안 검사

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # 매주 일요일 자정에 실행

jobs:
  security:
    name: 보안 취약점 검사
    runs-on: ubuntu-latest
    
    steps:
    - name: 저장소 체크아웃
      uses: actions/checkout@v3
      
    - name: Python 설정
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: 의존성 설치
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety
        
    - name: Bandit 보안 검사
      run: bandit -r src/ -f json -o bandit-results.json
      
    - name: Safety 의존성 검사
      run: safety check
      
    - name: CodeQL 초기화
      uses: github/codeql-action/init@v2
      with:
        languages: python
        
    - name: CodeQL 분석
      uses: github/codeql-action/analyze@v2
      
    - name: 시크릿 스캔
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 결과 업로드
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-results
        path: |
          bandit-results.json
          
  dependency-review:
    name: 의존성 리뷰
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: 저장소 체크아웃
      uses: actions/checkout@v3
      
    - name: 의존성 리뷰
      uses: actions/dependency-review-action@v3 